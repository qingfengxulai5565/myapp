name: 构建Android APK

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          python3-venv \
          build-essential \
          libffi-dev \
          libssl-dev \
          wget \
          unzip \
          openjdk-17-jdk
    
    - name: 安装Buildozer和Cython
      run: |
        pip install --upgrade pip
        pip install cython==0.29.33
        pip install buildozer==1.5.0
    
    - name: 正确安装Android SDK
      run: |
        echo "正确安装Android SDK..."
        
        # 创建Android SDK目录结构
        export ANDROID_HOME="$HOME/android-sdk"
        mkdir -p $ANDROID_HOME
        
        # 下载命令行工具
        cd $ANDROID_HOME
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        
        # 创建正确的目录结构
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
        
        # 设置环境变量
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH" >> $GITHUB_ENV
        
        # 显示目录结构
        echo "Android SDK目录结构:"
        find $ANDROID_HOME -type d | sort
    
    - name: 安装Android组件
      run: |
        echo "安装Android组件..."
        
        # 接受所有许可证
        yes | sdkmanager --licenses || true
        
        # 安装必要的组件
        sdkmanager "platforms;android-33"
        sdkmanager "build-tools;33.0.0"
        sdkmanager "platform-tools"
        sdkmanager "cmdline-tools;latest"
        
        # 验证安装
        echo "验证安装:"
        ls -la $ANDROID_HOME/build-tools/33.0.0/
        echo "aidl路径:"
        find $ANDROID_HOME -name "aidl" -type f 2>/dev/null | head -1
    
    - name: 设置Android许可证文件
      run: |
        mkdir -p ~/.android
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/.android/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.android/android-sdk-license
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> ~/.android/android-sdk-license
    
    - name: 修改buildozer.spec
      run: |
        echo "修改buildozer.spec..."
        # 确保使用正确的build-tools版本
        if ! grep -q "android.build_tools_version" buildozer.spec; then
          echo -e "\nandroid.build_tools_version = 33.0.0" >> buildozer.spec
        fi
        
        # 确保接受许可证
        sed -i 's/android.accept_sdk_license = .*/android.accept_sdk_license = true/g' buildozer.spec 2>/dev/null || true
        if ! grep -q "android.accept_sdk_license" buildozer.spec; then
          echo -e "\nandroid.accept_sdk_license = true" >> buildozer.spec
        fi
        
        # 设置Android SDK路径
        echo "android.sdk_path = $HOME/android-sdk" >> buildozer.spec
        
        echo "修改后的buildozer.spec相关部分:"
        grep -A2 -B2 "build_tools_version\|accept_sdk_license\|sdk_path" buildozer.spec || true
    
    - name: 构建APK
      timeout-minutes: 60
      run: |
        echo "开始构建APK..."
        echo "Android SDK路径: $ANDROID_HOME"
        echo "PATH: $PATH"
        
        # 验证aidl可用
        which aidl || find $ANDROID_HOME -name "aidl" -type f 2>/dev/null | head -1
        
        # 构建
        buildozer -v android debug
        
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ APK构建成功！"
          ls -la bin/*.apk
        else
          echo "❌ APK构建失败"
          echo "查看错误日志..."
          find .buildozer -name "*.log" -type f 2>/dev/null | head -3 | while read log; do
            echo "=== 日志文件: $log ==="
            tail -100 "$log" 2>/dev/null || echo "无法读取日志"
          done
          exit 1
        fi
    
    - name: 上传APK文件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: 我的APP安装包
        path: bin/*.apk
